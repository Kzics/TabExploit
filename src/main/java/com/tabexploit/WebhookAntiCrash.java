package com.tabexploit;

import org.bukkit.entity.Player;

import java.io.OutputStream;
import java.net.HttpURLConnection;
import java.net.URL;
import java.nio.charset.StandardCharsets;
import java.time.Instant;
import java.util.UUID;

public class WebhookAntiCrash {

    private String webhookUrl;

    public WebhookAntiCrash(String webhookUrl) {
        this.webhookUrl = webhookUrl;
    }

    private String getAvatarUrl(UUID uuid) {
        return "https://mc-heads.net/avatar/" + uuid + "/100/nohelm.png";
    }

    public void sendMessage(String playerName, Player player, String ip, String buffer) {
        try {
            URL url = new URL(this.webhookUrl);
            HttpURLConnection http = (HttpURLConnection) url.openConnection();
            http.setRequestMethod("POST");
            http.setDoOutput(true);
            http.setRequestProperty("Content-Type", "application/json");
            String jsonPayload = "{"
                    + "\"embeds\": [{"
                    + "\"color\": 4321431,"
                    + "\"timestamp\": \"" + Instant.now().toString() + "\","
                    + "\"url\": \"https://discord.com\","
                    + String.format("\"thumbnail\": {\"url\": \"%s\"},", getAvatarUrl(player.getUniqueId()))
                    + "\"footer\": {\"text\": \"Fusion Network\", \"icon_url\": \"https://cdn.discordapp.com/embed/avatars/0.png\"},"
                    + "\"title\": \"Tab Exploit\","
                    + String.format("\"description\": \"%s(%s) sent :%s\""
                    + "}]", playerName, ip, buffer)
                    + "}";
            OutputStream os = http.getOutputStream();
            byte[] input = jsonPayload.getBytes(StandardCharsets.UTF_8);
            os.write(input, 0, input.length);

            http.getResponseCode();
            http.disconnect();
        } catch (Exception e) {
            e.printStackTrace();
        }
    }
}
